---
title: '[JPA] OSIV'
author: da-nyee
date: 2022-01-18 23:48:34 +0900
categories: [TIL, JPA]
tags: [jpa, osiv]
---

그동안 OSIV를 잘못 알았어서, 제대로 이해하기 위해 정리한다 !

<br/>

## OSIV?

- Open Session In View
- 영속성 컨텍스트를 뷰까지 열어둔다는 뜻이다.
- 영속성 컨텍스트가 살아있으면, 엔티티는 영속 상태로 유지된다. 따라서 뷰에서도 지연 로딩을 사용할 수 있다.

<br/>

## 과거 OSIV - 요청당 트랜잭션

- OSIV의 핵심은 <b>뷰에서도 지연 로딩을 할 수 있게 하는 것이다.</b>
- 가장 단순한 구현 방법? 클라이언트의 요청이 들어오자마자 서블릿 필터나 스프링 인터셉터에서 트랜잭션을 시작한다. 그리고 요청이 끝날 때 트랜잭션도 끝낸다.
- 이렇게 하면, 영속성 컨텍스트가 시작부터 마지막까지 살아있다. 따라서 조회한 엔티티도 영속 상태를 유지한다.
- 그럼 뷰에서도 지연 로딩을 할 수 있어 엔티티를 미리 초기화할 필요가 없다.

![past-osiv](https://user-images.githubusercontent.com/50176238/149938798-2774982f-1153-4b96-9e1d-337bd8238b52.png)

### 문제점

- 해당 OSIV는 프레젠테이션 계층에서 엔티티를 변경할 수 있다는 문제점을 가진다.
- e.g. 유저를 출력할 때, 유저 이름을 보안상의 이유로 "dani"로 변경해서 출력해야 한다면?

```java
class UserController {

    public String readById(Long id) {
        User user = userService.readById(id);

        // 여기서 유저 이름을 변경한다.
        user.setName("dani");

        model.setAttribute("user", user);

        ...
    }
}
```

- 개발자는 뷰에서만 유저 이름을 "dani"로 변경하고 싶었다. 실제 데이터베이스의 유저 이름을 변경할 의도는 아니었다.
- 요청당 트랜잭션 방식의 OSIV는 뷰를 렌더링한 뒤에 트랜잭션을 커밋한다. 영속성 컨텍스트가 플러시된다는 의미이다.
- 영속성 컨텍스트의 변경 감지가 작동한다. 데이터베이스의 유저 이름이 "dani"로 변경되는 심각한 문제를 초래한다.
- 서비스 계층처럼 비즈니스 로직을 수행하는 곳에서 데이터를 변경하는 것은 당연하다. 그러나 프레젠테이션 계층에서 데이터를 잠시 변경했다고, 실제 데이터베이스에 이 내용이 반영되는 건 애플리케이션의 유지보수를 어렵게 만든다.

### 해결 방안

- 프레젠테이션 계층에서 엔티티를 수정하지 못하게 막는다.
- 엔티티를 읽기 전용 인터페이스로 제공한다.

```java
interface UserView {
    
    // 읽기 전용 메소드만 제공한다.
    String getName();
}

@Entity
class User implement UserView {
    ...
}

class UserService {

    public UserView readById(Long id) {
        return userRepository.findById(id);
    }
}
```

- 엔티티를 래핑한다.

```java
class UserWrapper {

    private User user;

    public UserWrapper(user) {
        this.user = user;
    }

    // 읽기 전용 메소드만 제공한다.
    public String getName() {
        return user.getName();
    }
}
```

- DTO만 반환한다.

```java
class UserDto {

    private String name;

    public String getName() {
        return name;
    }

    public void setName() {
        this.name = name;
    }
}

class UserController {

    public UserDto readById(Long id) {
        ...

        UserDto userDto = new UserDto();
        userDto.setName("dani");

        return userDto;
    }
}
```

- 이는 모두 코드량이 늘어난다는 단점이 있다.
- 한편 이어지는 OSIV를 활용하면, 코드량을 유지하며 앞선 문제점을 보완할 수 있다.

<br/>

## 스프링 OSIV - 비즈니스 계층 트랜잭션

![spring-osiv](https://user-images.githubusercontent.com/50176238/149939144-f8acf6bb-d8b1-4b97-ad16-7933b7b77fb2.png)

<br/>

## Reference

- [자바 ORM 표준 JPA 프로그래밍](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9788960777330&orderClick=LEA&Kc=)