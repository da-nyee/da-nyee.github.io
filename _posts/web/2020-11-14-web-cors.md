---
title: '[Web] CORS'
author: da-nyee
date: 2020-11-14 04:05:18 +0900
categories: [TIL, Web]
tags: [web, cors]
---

## CORS?

- êµì°¨ ì¶œì²˜ ìì› ê³µìœ (Cross-Origin Resource Sharing)
- í•œ ì¶œì²˜ì˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë‹¤ë¥¸ ì¶œì²˜ì˜ ìì›ì— ì ‘ê·¼í•˜ëŠ” ê¶Œí•œì„ `ë¸Œë¼ìš°ì €`ì—ì„œ í—ˆìš©í•˜ê²Œ í•˜ëŠ” HTTP í—¤ë” ê¸°ë°˜ ë©”ì»¤ë‹ˆì¦˜

## Origin

![origin_example](https://user-images.githubusercontent.com/50176238/99088237-214d2180-260f-11eb-9a3a-8264c1bb3740.png)

- URLì˜ `Protocol`, `Host`, `Port`ë¥¼ í†µí•´ ê°™ì€ ì¶œì²˜ì¸ì§€ ë‹¤ë¥¸ ì¶œì²˜ì¸ì§€ íŒë‹¨í•  ìˆ˜ ìˆë‹¤.

|                                          |<center>ê°™ì€ ì¶œì²˜</center>|<center>ë‹¤ë¥¸ ì¶œì²˜</center>|
|------------------------------------------|--------------------------|-------------------------|
|<center><b>https://github.com</b></center>|1. https://github.com/da-nyee<br/>2. https://github.com/da-nyee?tab=repositories<br/>3. https://github.com:8080 â¡ IE (O)|4. http://github.com<br/>5. https://api.github.com<br/>6. https://github.com:8080 â¡ IE (X)|

1. `Protocol ==`, `Host ==`, `Port ==`<br/>
2. `Protocol ==`, `Host ==`, `Port ==`<br/>
3. `Protocol ==`, `Host ==`, `Port !=` â¡ IE ë¸Œë¼ìš°ì €ëŠ” `Port`ê°€ ë‹¬ë¼ë„ ê°™ì€ ì¶œì²˜ë¡œ ì²˜ë¦¬í•œë‹¤.<br/>
4. `Protocol !=`, `Host ==`, `Port ==`<br/>
5. `Protocol ==`, `Host !=`, `Port ==`<br/>
6. `Protocol ==`, `Host ==`, `Port !=` â¡ IE ì™¸ ë¸Œë¼ìš°ì €ëŠ” `Port`ê°€ ë‹¤ë¥´ë©´ ë‹¤ë¥¸ ì¶œì²˜ë¡œ ì²˜ë¦¬í•œë‹¤.

## CORS Scenarios

- Requestì˜ `Origin` í—¤ë” == Responseì˜ `Access-Control-Allow-Origin` í—¤ë” â¡ ê°™ì€ ì¶œì²˜ë¡œ ì²˜ë¦¬í•œë‹¤.

### Preflighted Requests

![preflighted_reqs](https://user-images.githubusercontent.com/50176238/99097838-8575e280-261b-11eb-9f06-83f6e8572043.png)

- `Options` ë©”ì†Œë“œë¡œ ì˜ˆë¹„ ìš”ì²­ì„ ì „ì†¡í•˜ì—¬ ë³¸ ìš”ì²­ì„ ì „ì†¡í•˜ê¸°ì— ì•ˆì „í•œì§€ í™•ì¸í•œë‹¤.
- ì˜ˆë¹„ ìš”ì²­ì—ì„œ
    - Requestì˜ `Origin` == Responseì˜ `ACAO`ë©´ ê°™ì€ ì¶œì²˜ë¡œ ì²˜ë¦¬í•˜ì—¬ ë³¸ ìš”ì²­ì„ ìˆ˜í–‰í•œë‹¤.
    - Requestì˜ `Origin` != Responseì˜ `ACAO`ë©´ ë‹¤ë¥¸ ì¶œì²˜ë¡œ ì²˜ë¦¬í•˜ì—¬ ë³¸ ìš”ì²­ì„ ìˆ˜í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.
- `ë¸Œë¼ìš°ì €`ì—ì„œ ê°™ì€ ì¶œì²˜ì¸ì§€ ë‹¤ë¥¸ ì¶œì²˜ì¸ì§€ íŒë‹¨í•˜ê¸° ë•Œë¬¸ì— `ì„œë²„`ëŠ” 200ëŒ€ì˜ ì„±ê³µ ì½”ë“œë¥¼ ë°˜í™˜í•œë‹¤.

### Simple Requests

![simple_reqs](https://user-images.githubusercontent.com/50176238/99097867-8d358700-261b-11eb-898a-74987f9ede2c.png)

- ì˜ˆë¹„ ìš”ì²­ì´ ì—†ê³ , ì˜ˆë¹„ ìš”ì²­ì´ í–ˆë˜ í–‰ë™ì„ ë³¸ ìš”ì²­ì—ì„œ ì „ë¶€ ì²˜ë¦¬í•œë‹¤.
- ì œì•½ì‚¬í•­ì´ ë§ë‹¤.
    - `Request-Method`, `Allow-Methods` í—ˆìš© ì¢…ë¥˜
        - GET
        - HEAD
        - POST
    - `Request-Headers`, `Allow-Headers` í—ˆìš© ì¢…ë¥˜
        - Accept
        - Accept-Language
        - Content-Language
        - Content-Type
        - DPR
        - Downlink
        - Save-Data
        - Viewport-Width
        - Width
    - `Content-Type` í—ˆìš© ì¢…ë¥˜
        - application/x-www-form-urlencoded
        - multipart/form-data
        - text/plain

### Credentialed Requests

![credentialed_reqs](https://user-images.githubusercontent.com/50176238/99097887-932b6800-261b-11eb-934a-a84ba52e317b.png)

- ë³´ì•ˆì„ ë” ê°•í™”ì‹œí‚¨ ì‹œë‚˜ë¦¬ì˜¤ì´ë‹¤.
- `Cookie`ë¥¼ ë‹´ì„ ìˆ˜ ìˆê²Œ `Option`ì„ ì¤€ë‹¤. â¡ `ì„œë²„`ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ í•œ ë²ˆ ë” í™•ì¸í•œë‹¤.

|<center>Option</center>|<center>Description</center>|
|-----------------------|----------------------------|
|<center>same-origin (default)</center>|<center>ê°™ì€ ì¶œì²˜ê°„ ìš”ì²­ì—ë§Œ ì¸ì¦ ì •ë³´ë¥¼ ë‹´ëŠ”ë‹¤.</center>|
|<center>Include</center>|<center>ëª¨ë“  ìš”ì²­ì— ì¸ì¦ ì •ë³´ë¥¼ ë‹´ëŠ”ë‹¤.</center>|
|<center>Omit</center>|<center>ëª¨ë“  ìš”ì²­ì— ì¸ì¦ ì •ë³´ë¥¼ ë‹´ì§€ ì•ŠëŠ”ë‹¤.</center>|

- ì œì•½ì‚¬í•­ì´ ìˆë‹¤.
    - `ACAO`ì— `*` ì™€ì¼ë“œ ì¹´ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. â¡ `ëª…ì‹œì ì¸ URL`ì„ ì§€ì •í•´ì•¼ í•œë‹¤.
    - Responseì— ë°˜ë“œì‹œ `Access-Control-Allow-Credentials: true`ê°€ ì¡´ì¬í•´ì•¼ í•œë‹¤.

## CORS with Spring Security

```
@RequiredArgsConstructor
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    private final JwtTokenProvider jwtTokenProvider;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .httpBasic().disable()
                .cors().configurationSource(corsConfigurationSource())  ---------- 1.
                .and()
                    .csrf().disable()
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
                    .authorizeRequests()
                        .antMatchers("/api/v1/shops/**").hasRole("OWNER")
                        .antMatchers(HttpMethod.PUT, "/api/v1/users/**").hasAnyRole("USER", "OWNER")
                        .antMatchers(HttpMethod.DELETE, "/api/v1/users/**").hasAnyRole("USER", "OWNER")
                        .antMatchers(HttpMethod.GET, "/api/v1/users/").hasAnyRole("USER", "OWNER")
                        .anyRequest().permitAll()
                .and()
                    .addFilterBefore(new JwtAuthenticationFilter(jwtTokenProvider),
                            UsernamePasswordAuthenticationFilter.class);


    }

    @Bean --------- 2.
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();

        configuration.addAllowedOrigin("*");
        configuration.addAllowedHeader("*");
        configuration.addAllowedMethod("*");
        configuration.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
 }
```

1. CORS ì •ì±… ì„¤ì •íŒŒì¼ì— `CorsConfigurationSource` ë“±ë¡
    - ì´ ë¶€ë¶„ì„ ìƒëµí•˜ë©´ CORS ì •ì±…ì„ ì„¤ì •í•˜ëŠ” ì˜ë¯¸ê°€ ì—†ë‹¤.
2. CORS ì •ì±… ì„¤ì • Bean
    - `addAllowedOrigin()` â¡ í—ˆìš© URLì„ ì§€ì •í•œë‹¤.
    - `addAllowedHeader()` â¡ í—ˆìš© Headerë¥¼ ì§€ì •í•œë‹¤.
    - `addAllowedMethod()` â¡ í—ˆìš© Methodë¥¼ ì§€ì •í•œë‹¤.

## Refereneces

- [Cross-Origin Resource Sharing (CORS)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
- [[10ë¶„ í…Œì½”í†¡] ğŸ¤ ëŸ¿ê³ ì˜ CORS](https://www.youtube.com/watch?v=7iGIfcEsc2g&t=604s)
- [Spring Security CORS](https://toycoms.tistory.com/37)